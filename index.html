<!DOCTYPE html>
<html lang="vi">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Check-in</title>

<style>
body {
  background: #1e1e2e;
  display: flex;
  justify-content: center;
  padding-top: 40px;
  font-family: Arial, sans-serif;
}
.form {
  width: 320px;
  background: #111;
  padding: 20px;
  border-radius: 12px;
  color: white;
}
.form h2 {
  margin-top: 0;
}
.input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  background: #222;
  color: white;
  border: none;
}
button {
  width: 100%;
  padding: 12px;
  background: #4f46e5;
  border: none;
  border-radius: 8px;
  margin-top: 15px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>

<body>

<form class="form" onsubmit="event.preventDefault(); sendData();">
  <h2>CHECK-IN</h2>

  <input id="hoten" class="input" placeholder="H·ªç v√† t√™n">

  <select id="mode" class="input">
    <option value="Online">Online</option>
    <option value="Offline">Offline</option>
  </select>

  <label style="margin-top:10px; font-size:14px;">Ch·ª•p ·∫£nh / ch·ªçn ·∫£nh:</label>
  <input id="imageInput" type="file" accept="image/*" capture="camera" class="input">

  <button>G·ª≠i ƒëi·ªÉm danh</button>

  <div id="status" style="margin-top:10px; font-size:14px;"></div>
</form>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz2xMh0MpAzH0QS9i32CUEWFDrIJg-54CKuNYbG4Eslu3Rk2YiRTr1MNUmiR0sT09N1mA/exec"; 

// üîç H√†m l·∫•y ƒë·ªãa ch·ªâ t·ª´ lat/lng b·∫±ng OpenStreetMap (FREE ‚Äì kh√¥ng c·∫ßn API KEY)
async function getAddress(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    let res = await fetch(url);
    let data = await res.json();
    return data.display_name || "Kh√¥ng x√°c ƒë·ªãnh";
  } catch (e) {
    return "Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ";
  }
}

async function sendData() {
  let hoten = document.getElementById("hoten").value.trim();
  let mode = document.getElementById("mode").value;
  let imgFile = document.getElementById("imageInput").files[0];
  let statusBox = document.getElementById("status");

  if (!hoten) {
    statusBox.innerHTML = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p h·ªç t√™n!";
    statusBox.style.color = "red";
    return;
  }

  statusBox.innerHTML = "‚è≥ ƒêang l·∫•y v·ªã tr√≠...";
  statusBox.style.color = "white";

  navigator.geolocation.getCurrentPosition(async pos => {
      let lat = pos.coords.latitude;
      let lng = pos.coords.longitude;

      // üìç L·∫•y ƒë·ªãa ch·ªâ t·ª´ OSM
      let address = await getAddress(lat, lng);

      // üñº X·ª≠ l√Ω ·∫£nh
      let base64img = "";
      if (imgFile) {
        base64img = await toBase64(imgFile);
      }

      statusBox.innerHTML = "‚è≥ ƒêang g·ª≠i d·ªØ li·ªáu...";

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          hoten,
          mode,
          lat,
          lng,
          address,
          image: base64img
        })
      })
      .then(r => r.json())
      .then(res => {
        statusBox.style.color = "lightgreen";
        statusBox.innerHTML = `
          ‚úîÔ∏è Ghi nh·∫≠n th√†nh c√¥ng!<br><br>
          üè† <b>ƒê·ªãa ch·ªâ:</b><br>${address}<br><br>
          üñº <a href="${res.imageUrl}" target="_blank" style="color:cyan;">Xem ·∫£nh</a>
        `;
      })
      .catch(err => {
        statusBox.style.color = "red";
        statusBox.innerHTML = "‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu!";
        console.error(err);
      });

  }, err => {
      statusBox.style.color = "red";
      statusBox.innerHTML = "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS! H√£y b·∫≠t ƒë·ªãnh v·ªã.";
  });
}

// üîÅ Chuy·ªÉn file ·∫£nh ‚Üí base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
</script>


</body>
</html>
